#!/usr/bin/env bash

MKCERT_DIRECTORY="/etc/apache2/certs"

# Simple validator for domains
# to prevent use wildcards or subdomains
# this command always create wildcard certificate
function _validate() {
  echo $1 | grep -qP "^[\w\-]+\.[\w]+$"
  [ $? -eq 0 ] && return 0 || echo -e "\e[0;31mInvalid format for '${1}' domain\e[0m"; return 1
}

[ -d "${MKCERT_DIRECTORY}" ] || sudo mkdir -p "${MKCERT_DIRECTORY}"

status=0
case "${1:-}" in
  -i|-u )
    for x in "${@:2}"; do
      if _validate $x; then
        sudo echo -n "Creating ${x} certificate"
        sudo mkcert -ecdsa -cert-file "${MKCERT_DIRECTORY}/${x}.pem" -key-file "${MKCERT_DIRECTORY}/${x}.key" "${x}" "*.${x}" &>/dev/null
        if [[ $? -eq 0 ]]; then
          sudo cat "${MKCERT_DIRECTORY}/${x}.pem" | sudo tee -a "${MKCERT_DIRECTORY}/${x}.key" &>/dev/null
          sudo mv "${MKCERT_DIRECTORY}/${x}.key" "${MKCERT_DIRECTORY}/${x}.pem"
          echo -e " \e[0;32m[DONE]\e[0m"
        else
          echo -e " \e[0;31m[FAILED]\e[0m"
          status=1
        fi
      else
        status=1
      fi
    done
    ;;
  -r|-d )
    for x in "${@:2}"; do
      if _validate $x; then
        echo -n "Deleting ${x} certificate"
        sudo find ${MKCERT_DIRECTORY} -type f -name "${x}*" -delete 2>/dev/null
        [ $? -eq 0 ] && echo -e " \e[0;32m[DONE]\e[0m" || echo -e " \e[0;31m[FAILED]\e[0m"; status=1
      else
        status=1
      fi
    done
    ;;
  -l )
    ls ${MKCERT_DIRECTORY} 2>/dev/null | awk '{print "- "$0}'
    ;;
  * )
    echo "Usage: a2c -i domain.tld ..."
    echo
    echo "* This command ask for sudo password, when you create or delete certificates"
    echo "* This command join pem and key generated by mkcert on single file."
    echo "* All certificates saved to /etc/apache2/certificates"
    echo "* The generate certificate always support wildcards"
    echo "* Multiples domains is supported"
    echo "  with -i, -u option is generated one certificate by domain"
    echo
    echo "Options:"
    echo "-i, -u Create or update if exists the certificates for domain.tld"
    echo "-r, -d Delete the certificates for domain.tld"
    echo "-l     List all created certificates"
    echo "-h     Print this text and exit"
    echo
    ;;
esac
exit $status